<!DOCTYPE html>
<html>

<head>

    <title>WebGL 3D Model Viewer Using three.js</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://sxia2.github.io/waist_project/Program4/three.js"></script>
    <script src="https://sxia2.github.io/waist_project/Program4/Detector.js"></script>
    <script src="https://sxia2.github.io/waist_project/Program4/OrbitControls.js"></script>
    <script src="https://sxia2.github.io/waist_project/Program4/OBJLoader.js"></script>
    <!-- <script src="https://sxia2.github.io/waist_project/Program4/GLTFLoader.js"></script> -->
    <script src="https://sxia2.github.io/waist_project/Program4/RoomEnvironment.js"></script>
    <script src="https://sxia2.github.io/waist_project/Program4/dat.gui.module.js"></script>

    <!-- <script src="https://sxia2.github.io/waist_project/Program4/Box3.js"></script> -->

    <style>
        .myDiv {
            border: 5px outset red;
            background-color: lightblue;
            text-align: center;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }
    </style>
</head>

<body>
    <table>
        <tr>
            <th>
                <p>Measurement</p>
                <p>(mm)</p>
            </th>
            <th>
                <p>3D view</p>
            </th>
        </tr>
        <tr>
            <td>
                <p>Subject height:</p>
                <p id="height">null</p>
                <p>Current waist height:</p>

                <p id="plane_location">null</p>
            </td>
            <td id="webgl-container"> </td>
        </tr>
        <tr>
            <td>
                <p>Month</p>
            </td>
            <td>
                <p>Month</p>
            </td>
        </tr>
    </table>

    <script>

        if (!Detector.webgl) {
            Detector.addGetWebGLMessage();
        }

        var container;
        var ratio = 1000
        var camera, controls, scene, renderer;
        var lighting, ambient, keyLight, fillLight, backLight;
        var path = 'https://sxia2.github.io/waist_project/Program4/assets/SSFemale.obj'
        init();
        animate();


        function init() {

            container = document.getElementById("webgl-container")
            // document.body.appendChild(container);



            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            // renderer.setClearColor(new THREE.Color("hsl(10, 10%, 10%)"));

            container.appendChild(renderer.domElement);

            /* Scene */
            pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x888888);
            room = new THREE.RoomEnvironment()
            scene.environment = pmremGenerator.fromScene(room, 0.04).texture;

            var ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);

            var light1 = new THREE.PointLight(0xffffff, 1, 0);
            light1.position.set(0, 200, 0);
            scene.add(light1);

            var light2 = new THREE.PointLight(0xffffff, 1, 0);
            light2.position.set(100, 200, 100);
            scene.add(light2);

            var light3 = new THREE.PointLight(0xffffff, 1, 0);
            light3.position.set(- 100, - 200, - 100);
            scene.add(light3);
            /* Camera */

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 100);
            camera.position.set(0, 0, 3.5);
            camera.lookAt(0, 0, 0);
            camera.updateProjectionMatrix()
            var ship_material = new THREE.MeshPhongMaterial({

                color: 0x64747c,
                emissive: 0x0,
                specular: 0x111111,
                shininess: 30,
                flatShading: false,
                // wireframe: true

            });
            var objLoader = new THREE.OBJLoader();
            obj_loaded = objLoader.load(path,
                function (obj) {
                    obj.traverse(function (child) {
                        // if (child instanceof THREE.Mesh) {
                        child.material = ship_material;
                        // }
                    });
                    obj.scale.set(1 / ratio, 1 / ratio, 1 / ratio)
                    scene.add(obj);
                    // console.log(obj)
                    obj_loaded = obj
                    // console.log(obj_loaded)
                    var box = new THREE.Box3().setFromObject(obj);
                    console.log(box.size().y)
                    document.getElementById("height").innerHTML = (box.size().y*ratio).toFixed(2);
                    document.getElementById("plane_location").innerHTML = (plane.position.y*ratio+0.5*box.size().y*ratio).toFixed(2);
                    obj.translateY(-0.5*box.size().y);
                },
                // called when loading is in progresses
                function (xhr) {

                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');

                },
                // called when loading has errors
                function (error) {

                    console.log('An error happened');

                }
            );

            /* define a plane*/
            geometry = new THREE.PlaneGeometry(1, 1);
            material = new THREE.MeshPhongMaterial({
                color: 0xffff00, side: THREE.DoubleSide, opacity: 0.5,
                transparent: true
            });
            plane = new THREE.Mesh(geometry, material);
            plane.lookAt(new THREE.Vector3(0, 1, 0));
            // plane.translateZ(-0.05);
            scene.add(plane);


            

            /* Renderer */

            /* Controls */

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = true;
            // controls.minPolarAngle = 3.14 / 4
            // controls.maxPolarAngle = 3.14 / 4
            /* Events */

            window.addEventListener('resize', onWindowResize, false);
            window.addEventListener('keydown', onKeyboardEvent, false);



        }


        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        }

        function onKeyboardEvent(e) {

            if (e.code === 'KeyL') {

                lighting = !lighting;

                if (lighting) {

                    ambient.intensity = 0.25;
                    scene.add(keyLight);
                    scene.add(fillLight);
                    scene.add(backLight);

                } else {

                    ambient.intensity = 1.0;
                    scene.remove(keyLight);
                    scene.remove(fillLight);
                    scene.remove(backLight);

                }

            }

        }

        function animate() {

            requestAnimationFrame(animate);

            controls.update();

            render();

        }

        function render() {

            renderer.render(scene, camera);

        }

    </script>
</body>

</html>